CREATE OR REPLACE PROCEDURE Daily_RiderPrem
AS
    CurrentDay    VARCHAR(11);
    PreviousDay   VARCHAR(11);
BEGIN
    CurrentDay := TO_CHAR(TRUNC(SYSDATE), 'DD-MON-YYYY');
    PreviousDay := TO_CHAR(TRUNC(SYSDATE - 1), 'DD-MON-YYYY');
    DBMS_OUTPUT.PUT_LINE('Current Day: ' || CurrentDay);
    DBMS_OUTPUT.PUT_LINE('Previous Day: ' || PreviousDay);

    -- Deleting data for the current and previous day
    DELETE FROM FIN_DWH_RPT.RIDER_PREMIUM
    WHERE ACCOUNTING_DATE >= TRUNC(SYSDATE - 1)
      AND ACCOUNTING_DATE < TRUNC(SYSDATE + 1);

    BEGIN
        EXECUTE IMMEDIATE 'DROP TABLE RIDER_PREMIUM_NEW';
    EXCEPTION
        WHEN OTHERS THEN
            IF SQLCODE != -942 THEN
                RAISE;
            END IF;
    END;

    -- Inserting data for the current and previous day
    CREATE TABLE RIDER_PREMIUM_NEW AS
    SELECT X.ACCOUNTING_DATE, X.ACCT_PREM_TYPE, X.ADJ_DATE, X.AGENT_BRANCH_CODE, X.AGENT_CODE, X.AGENT_NAME, X.ANNULIZED,
           X.BENEFIT_TERM, X.BOOKING_FREQUENCY, X.CHANNEL, X.ISSUANCE_YEAR, X.MONTH, X.PACKAGE_CODE, X.POLICY_REF,
           X.PREMIUM_TERM, X.PREM_AMOUNT, X.PRODUCT_ID, X.RIDER_NAME, X.RIDER_TYPE, X.SUBFACTOR_1_VAL, X.T1_VALUE,
           X.VERTICAL_CODE, X.VERTICAL, X.PRODUCT_MIX, X.NB_PREMIUM, X.ANP, X.RNOP, X.UNOP, X.LT_3X, X.GT_3X,
           X.LT_3X_NB_PREM, X.GT_3X_NB_PREM, X.U_PREMIUM_AMT, X.LT_1X, X.R_1X_2X, X.R_2X_3X, X.LT_1X_NB_PREM,
           X.R_1X_2X_NB_PREM, X.R_2X_3X_NB_PREM
    FROM (
        SELECT A.POLICY_REF, C.BOOKING_FREQUENCY, C.PREMIUM_TERM, C.PRODUCT_ID, C.AGENT_CODE, C.AGENT_NAME,
               C.AGENT_BRANCH_CODE, C.CHANNEL, A.ACCOUNTING_DATE, SUM(POSTING_AMT) * -1 AS PREM_AMOUNT,
               C_PREMIUM_TYPE AS ACCT_PREM_TYPE, C.VERTICAL_CODE, C.BENEFIT_TERM,
               OWB_ADMIN.GET_FISCAL_YEAR(C.ADJ_DATE) AS ISSUANCE_YEAR, C.ADJ_DATE, ANNULIZED, PACKAGE_CODE,
               SUBSTR(T1_VALUE, -2) AS T1_VALUE, D.RIDER_NAME, D.RIDER_TYPE, A.SUBFACTOR_1_VAL,
               TO_CHAR(A.ACCOUNTING_DATE, 'Mon-RRRR') AS MONTH, E.VERTICAL, E.PRODUCT_MIX,
               SUM(E.NB_PREMIUM) AS NB_PREMIUM, SUM(E.ANP) AS ANP, SUM(E.RNOP) AS RNOP, SUM(E.UNOP) AS UNOP,
               SUM(E.LT_3X) AS LT_3X, SUM(E.GT_3X) AS GT_3X, SUM(E.LT_3X_NB_PREM) AS LT_3X_NB_PREM,
               SUM(E.GT_3X_NB_PREM) AS GT_3X_NB_PREM, SUM(E.U_PREMIUM_AMT) AS U_PREMIUM_AMT,
               SUM(E.LT_1X) AS LT_1X, SUM(E.R_1X_2X) AS R_1X_2X, SUM(E.R_2X_3X) AS R_2X_3X,
               SUM(E.LT_1X_NB_PREM) AS LT_1X_NB_PREM, SUM(E.R_1X_2X_NB_PREM) AS R_1X_2X_NB_PREM,
               SUM(E.R_2X_3X_NB_PREM) AS R_2X_3X_NB_PREM
        FROM DWH_ACCOUNTING_FACT_VW A
        JOIN ODS_ACCOUNT_CATEGORY_MAST B ON A.ACCOUNT_CATEGORY_CODE = B.C_ACCOUNT_CATEGORY_CODE
        LEFT JOIN FACT_POLICY_VW C ON A.POLICY_REF = C.POLICY_REF
        LEFT JOIN IRDAUSR.IRDA_RIDER_TYPE_TAB D ON SUBSTR(A.T1_VALUE, -2) = D.RIDER_CODE
        LEFT JOIN OWB_ADMIN.RPT_APR_RIDER_YTD_DTL_DATA E ON A.POLICY_REF = E.POLICY_REF AND A.ACCOUNTING_DATE = E.ACCOUNTING_DATE
        WHERE B.C_PREMIUM_TYPE IN ('SP', 'FY', 'RP')
          AND B.C_ACCOUNT_TYPE = 'GPW'
          AND A.ACCOUNTING_DATE >= TRUNC(SYSDATE - 1)
          AND A.ACCOUNTING_DATE < TRUNC(SYSDATE + 1)
          AND SUBSTR(T1_VALUE, -2) NOT IN ('ZZ', 'LP', '21')
        GROUP BY A.POLICY_REF, C.BOOKING_FREQUENCY, C.PREMIUM_TERM, C.PRODUCT_ID, C.AGENT_CODE, C.AGENT_NAME,
                 C.AGENT_BRANCH_CODE, C.CHANNEL, A.ACCOUNTING_DATE, B.C_PREMIUM_TYPE, C.VERTICAL_CODE, C.BENEFIT_TERM,
                 OWB_ADMIN.GET_FISCAL_YEAR(C.ADJ_DATE), C.ADJ_DATE, ANNULIZED, PACKAGE_CODE, SUBSTR(T1_VALUE, -2),
                 D.RIDER_NAME, D.RIDER_TYPE, A.SUBFACTOR_1_VAL, TO_CHAR(A.ACCOUNTING_DATE, 'Mon-RRRR'), E.VERTICAL, E.PRODUCT_MIX
    ) X
    WHERE X.PREM_AMOUNT <> 0;

    -- Inserting data into the target table
    INSERT INTO FIN_DWH_RPT.RIDER_PREMIUM (
        ACCOUNTING_DATE, ACCT_PREM_TYPE, ADJ_DATE, AGENT_BRANCH_CODE, AGENT_CODE, AGENT_NAME, ANNULIZED, ANP,
        BENEFIT_TERM, BOOKING_FREQUENCY, CHANNEL, GT_3X, GT_3X_NB_PREM, ISSUANCE_YEAR, LT_1X, LT_1X_NB_PREM,
        LT_3X, LT_3X_NB_PREM, MONTH, NB_PREMIUM, PACKAGE_CODE, POLICY_REF, PREMIUM_TERM, PREM_AMOUNT, PRODUCT_ID,
        PRODUCT_MIX, RIDER_NAME, RIDER_TYPE, RNOP, R_1X_2X, R_1X_2X_NB_PREM, R_2X_3X, R_2X_3X_NB_PREM,
        SUBFACTOR_1_VAL, T1_VALUE, UNOP, U_PREMIUM_AMT, VERTICAL, VERTICAL_CODE
    )
    SELECT ACCOUNTING_DATE, ACCT_PREM_TYPE, ADJ_DATE, AGENT_BRANCH_CODE, AGENT_CODE, AGENT_NAME, ANNULIZED, ANP,
           BENEFIT_TERM, BOOKING_FREQUENCY, CHANNEL, GT_3X, GT_3X_NB_PREM, ISSUANCE_YEAR, LT_1X, LT_1X_NB_PREM,
           LT_3X, LT_3X_NB_PREM, MONTH, NB_PREMIUM, PACKAGE_CODE, POLICY_REF, PREMIUM_TERM, PREM_AMOUNT, PRODUCT_ID,
           PRODUCT_MIX, RIDER_NAME, RIDER_TYPE, RNOP, R_1X_2X, R_1X_2X_NB_PREM, R_2X_3X, R_2X_3X_NB_PREM,
           SUBFACTOR_1_VAL, T1_VALUE, UNOP, U_PREMIUM_AMT, VERTICAL, VERTICAL_CODE
    FROM RIDER_PREMIUM_NEW;

    -- Merging data to update additional columns
    MERGE INTO FIN_DWH_RPT.RIDER_PREMIUM t
    USING (
        SELECT DISTINCT a.policy_ref, b.MAIN_CHANNEL, b.SUB_CHANNEL, b.VERTICAL_NAME, b.RELATIONSHIP_NAME, b.P_PRODUCT_TYPE, a.NOP
        FROM FIN_DWH_RPT.RIDER_PREMIUM a
        JOIN OWB_ADMIN.RPT_POL_AGNT_CHNL_SUBCHNL_VER b ON a.POLICY_REF = b.POLICY_REF
    ) s
    ON (t.POLICY_REF = s.POLICY_REF)
    WHEN MATCHED THEN
        UPDATE SET t.MAIN_CHANNEL = s.MAIN_CHANNEL,
                   t.SUB_CHANNEL = s.SUB_CHANNEL,
                   t.VERTICAL_NAME = s.VERTICAL_NAME,
                   t.RELATIONSHIP_NAME = s.RELATIONSHIP_NAME,
                   t.RETAIL_GRP = s.P_PRODUCT_TYPE
        WHERE t.ACCOUNTING_DATE >= SYSDATE - 3;

    -- Updating IRNB based on ACCT_PREM_TYPE
    UPDATE FIN_DWH_RPT.RIDER_PREMIUM
    SET IRNB = CASE
                   WHEN ACCT_PREM_TYPE = 'SP' THEN PREM_AMOUNT * 0.1
                   WHEN ACCT_PREM_TYPE = 'RP' THEN 0
                   ELSE PREM_AMOUNT
               END
    WHERE IRNB IS NULL;

    -- Setting default values for unmapped channels
    UPDATE FIN_DWH_RPT.RIDER_PREMIUM
    SET MAIN_CHANNEL = 'UNMAPPED',
        SUB_CHANNEL = 'UNMAPPED',
        VERTICAL_NAME = 'UNMAPPED',
        RELATIONSHIP_NAME = 'UNMAPPED',
        RETAIL_GRP = 'UNMAPPED'
    WHERE MAIN_CHANNEL IS NULL;

END Daily_RiderPrem;
