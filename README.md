-- Pre-aggregate ZZ cover values
WITH zz_cover AS (
    SELECT POLICY_REF, MAX(SUM_INSURED_WHOLE_COVER) AS TOTAL_ZZ_COVER
    FROM RIDER_SUM_ASSURED
    WHERE T1_CODE = 'ZZ'
    GROUP BY POLICY_REF
),
non_zz_cover AS (
    SELECT POLICY_REF, T1_CODE, SUM_INSURED_WHOLE_COVER AS TOTAL_NON_ZZ_COVER
    FROM RIDER_SUM_ASSURED
    WHERE T1_CODE <> 'ZZ'
      AND SUM_INSURED_WHOLE_COVER IS NOT NULL
)

-- Join pre-aggregated results
SELECT DISTINCT 
    nzc.POLICY_REF, 
    nzc.T1_CODE, 
    zzc.TOTAL_ZZ_COVER, 
    nzc.TOTAL_NON_ZZ_COVER,
    ROUND(nzc.TOTAL_NON_ZZ_COVER / NULLIF(zzc.TOTAL_ZZ_COVER, 0), 0) AS rider_multiplier
FROM non_zz_cover nzc
LEFT JOIN zz_cover zzc
  ON nzc.POLICY_REF = zzc.POLICY_REF;
